name: Process Novel Folder

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  process-novel:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install chardet

      - name: Process novel folder
        run: |
          import os
          import zipfile
          import json
          from chardet import detect

          NOVEL_DIR = "novel"
          OUTPUT_DIR = "output"

          # Common encodings to try (in order of preference)
          COMMON_ENCODINGS = [
              'utf-8',
              'gb18030',
              'big5',
              'gbk',
              'gb2312',
              'utf-16',
              'iso-8859-1'
          ]

          os.makedirs(OUTPUT_DIR, exist_ok=True)

          def detect_encoding(file_path):
              with open(file_path, 'rb') as f:
                  rawdata = f.read(1024)
                  result = detect(rawdata)
                  if result['confidence'] > 0.9:
                      return result['encoding']
              
              for encoding in COMMON_ENCODINGS:
                  try:
                      with open(file_path, 'r', encoding=encoding) as f:
                          f.read(1024)
                      return encoding
                  except:
                      continue
              
              return 'utf-8'

          def read_file_with_fallback(file_path):
              encoding = detect_encoding(file_path)
              try:
                  with open(file_path, 'r', encoding=encoding) as f:
                      return f.read()
              except Exception as e:
                  pass
              
              for encoding in COMMON_ENCODINGS:
                  try:
                      with open(file_path, 'r', encoding=encoding) as f:
                          return f.read()
                  except:
                      continue
              
              return f"ERROR: Could not decode file with any encoding"

          def unzip_and_read(zip_path):
              with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                  temp_dir = os.path.splitext(zip_path)[0]
                  zip_ref.extractall(temp_dir)
                  
                  contents = {}
                  for root, _, files in os.walk(temp_dir):
                      for file in files:
                          file_path = os.path.join(root, file)
                          if file.lower().endswith('.txt'):
                              contents[file] = read_file_with_fallback(file_path)
                          else:
                              contents[file] = "Non-text file (not processed)"
                  return contents

          def process_novel_folder():
              zip_files = [f for f in os.listdir(NOVEL_DIR) if f.endswith(".zip")]
                            
              for file in zip_files:
                  zip_path = os.path.join(NOVEL_DIR, file)
                  print(f"\nProcessing {zip_path}...")
                  
                  contents = unzip_and_read(zip_path)
                  
                  json_filename = os.path.splitext(file)[0] + ".json"
                  output_path = os.path.join(OUTPUT_DIR, json_filename)
                  with open(output_path, 'w', encoding='utf-8') as f:
                      json.dump(contents, f, ensure_ascii=False, indent=4)
                  
                  # Print exactly 3 items from the JSON to console
                  print(f"\nSample content from {json_filename} (showing 3 items):")
                  print("=" * 60)
                  items_shown = 0
                  for filename, content in contents.items():
                      if items_shown >= 3:
                          break
                      content_preview = (content[:100].replace('\n', ' ') + "...") if isinstance(content, str) and len(content) > 100 else content
                      print(f"ðŸ“„ {filename}")
                      print(f"   {content_preview}\n")
                      items_shown += 1
                  
                  remaining_items = len(contents) - 3
                  if remaining_items > 0:
                      print(f"... plus {remaining_items} more items not shown ...")
                  print("=" * 60)
                  print(f"âœ… Saved {json_filename} (total items: {len(contents)})")

          process_novel_folder()
        shell: python

      - name: Commit and push changes
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/
          git commit -m "Update individual JSON files" || echo "No changes to commit"
          git push
