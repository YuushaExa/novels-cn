name: Process Novel Folder

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  process-novel:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install chardet python-docx

      - name: Process novel folder
        run: |
          import os
          import zipfile
          import json
          import re
          import shutil
          import traceback
          from chardet import detect
          from docx import Document
          from docx.shared import Pt
          from docx.enum.text import WD_PARAGRAPH_ALIGNMENT

          NOVEL_DIR = "novel"
          OUTPUT_DIR = "output"

          # Common encodings to try (in order of preference)
          COMMON_ENCODINGS = [
              'utf-8', 'gb18030', 'big5', 'gbk', 'gb2312',
              'utf-16', 'iso-8859-1'
          ]

          os.makedirs(OUTPUT_DIR, exist_ok=True)

          # --- Utility Functions (Encoding, Chinese Numerals) ---
          def detect_encoding(file_path):
              try:
                  with open(file_path, 'rb') as f:
                      rawdata = f.read(4096);
                      if not rawdata: return None
                      result = detect(rawdata)
                      return result['encoding'] if result['encoding'] and result['confidence'] > 0.7 else None
              except Exception: return None

          def read_file_with_fallback(file_path):
              detected_enc = detect_encoding(file_path); tried_encodings = set()
              if detected_enc:
                  try:
                      norm_enc = detected_enc.lower();
                      with open(file_path, 'r', encoding=norm_enc) as f: return f.read()
                  except (UnicodeDecodeError, LookupError): pass
                  finally: tried_encodings.add(detected_enc.lower()) if detected_enc else None
              for enc in COMMON_ENCODINGS:
                  norm_enc = enc.lower();
                  if norm_enc in tried_encodings: continue
                  try:
                      with open(file_path, 'r', encoding=norm_enc) as f: print(f"Read {os.path.basename(file_path)} with fallback '{norm_enc}'"); return f.read()
                  except (UnicodeDecodeError, LookupError): tried_encodings.add(norm_enc)
                  except FileNotFoundError: raise ValueError(f"File not found: {file_path}")
                  except Exception: tried_encodings.add(norm_enc)
              raise ValueError(f"Could not decode {os.path.basename(file_path)} with tried encodings ({', '.join(tried_encodings)}).")

          def chinese_to_arabic(chinese_num_str):
              if not isinstance(chinese_num_str, str): return int(chinese_num_str) if isinstance(chinese_num_str, (int, float)) else None
              s = chinese_num_str.strip();
              if not s: return None
              if s.isdigit(): return int(s)
              if not all(c in '零一二三四五六七八九十百千万億' for c in s): return None
              n_map={'零':0,'一':1,'二':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9}; u_map={'十':10,'百':100,'千':1000,'万':10000,'億':100000000}
              t=0; c=0; sec=0; u=1;
              if s=='十': return 10
              if s.startswith('十'): s='一'+s
              for char in s:
                  if char in n_map: c=n_map[char]
                  elif char in u_map:
                      cur_u=u_map[char];
                      if cur_u in [10000,100000000]: sec+=(c if c>0 else (1 if u>1 else 0))*u; t+=sec*cur_u; sec=0; c=0; u=1
                      else: sec+=(c if c>0 else 1)*cur_u; c=0; u=cur_u
                  else: return None
              sec+=c*(u if u>1 and c>0 and sec==0 else 1); t+=sec
              return t
          # --- End Utility Functions ---

          def create_docx_from_novel(novel_name, chapters):
              doc = Document()
              # Set default font
              style = doc.styles['Normal']
              font = style.font
              font.name = 'SimSun'
              font.size = Pt(12)
              
              # Add title
              title = doc.add_paragraph(novel_name)
              title.style = doc.styles['Heading 1']
              title.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER
              
              # Add each chapter
              for chapter in sorted(chapters, key=lambda x: chinese_to_arabic(x['chapter_num'])):
                  # Add chapter title
                  chap_title = doc.add_paragraph(f"Chapter {chapter['chapter_num']}")
                  chap_title.style = doc.styles['Heading 2']
                  
                  # Add chapter content
                  content = chapter['content'].strip()
                  for paragraph in content.split('\n'):
                      if paragraph.strip():  # Skip empty paragraphs
                          p = doc.add_paragraph(paragraph)
                          p.style = doc.styles['Normal']
                  
                  # Add page break between chapters
                  doc.add_page_break()
              
              # Save document
              output_path = os.path.join(OUTPUT_DIR, f"{novel_name}.docx")
              doc.save(output_path)
              print(f"Created DOCX file: {output_path}")

          def process_novel_folder():
              try:
                  for item in os.listdir(NOVEL_DIR):
                      item_path = os.path.join(NOVEL_DIR, item)
                      if os.path.isdir(item_path):
                          print(f"\nProcessing novel folder: {item}")
                          chapters = []
                          
                          # Process each chapter file
                          for chapter_file in sorted(os.listdir(item_path)):
                              if chapter_file.endswith('.txt'):
                                  try:
                                      chapter_path = os.path.join(item_path, chapter_file)
                                      content = read_file_with_fallback(chapter_path)
                                      
                                      # Extract chapter number from filename
                                      chapter_num_match = re.search(r'第([零一二三四五六七八九十百千万億]+)章', chapter_file)
                                      chapter_num = chapter_num_match.group(1) if chapter_num_match else chapter_file.split('.')[0]
                                      
                                      chapters.append({
                                          'chapter_num': chapter_num,
                                          'content': content
                                      })
                                      print(f"Processed chapter: {chapter_file}")
                                  except Exception as e:
                                      print(f"Error processing {chapter_file}: {str(e)}")
                                      continue
                          
                          if chapters:
                              create_docx_from_novel(item, chapters)
                              print(f"Successfully processed novel: {item}")
                          else:
                              print(f"No valid chapters found for novel: {item}")
              except Exception as e:
                  print(f"Error processing novel folder: {str(e)}")
                  traceback.print_exc()

          # --- Main Execution ---
          process_novel_folder()
        shell: python

      - name: Commit and push changes
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "Adding output directory changes..."
          git add output/
          echo "Current Git status:"
          git status
          if git diff --staged --quiet -- 'output/'; then
            echo "No changes detected in output/ directory. Nothing to commit."
          else
            echo "Changes detected in output/. Committing..."
            git commit -m "Update processed novels (DOCX format)"
            echo "Pushing changes..."
            git push
          fi
